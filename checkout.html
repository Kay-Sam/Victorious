<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Checkout</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
<link rel="stylesheet" href="assets/css/shop.css">
<link rel="stylesheet" href="assets/css/cart.css">

<style>
.checkout-box { background: #fff; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);}
.btn-orange { background: #ff7a00; color: #fff; }
.btn-orange:hover { background: #e96c00; color: #fff; }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top shadow-sm px-4 py-1 bg-white">
  <div class="container-fluid">
    <a href="index.html" class="navbar-brand">
      <img src="assets/img/logo.png" alt="Logo" height="50">
    </a>
    <div class="d-flex align-items-center order-lg-2 ms-auto" style="margin-right: 15px;">
      <a class="nav-link position-relative me-2" href="cart.html" style="margin-left: 10px; margin-right: 10px;">
        <i class="bi bi-cart4 fs-4"></i>
        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">0</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
        aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse justify-content-end order-lg-1" id="navbarNavDropdown">
      <ul class="navbar-nav align-items-center me-3">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="shop.html">Shop</a></li>
      </ul>
      <form class="d-flex" role="search" onsubmit="return false;">
        <input id="search-input" class="form-control me-2" type="search" placeholder="Search products...">
        <button class="btn btn-orange" type="submit"><i class="bi bi-search"></i></button>
      </form>
    </div>
  </div>
</nav>

<!-- CHECKOUT -->
<div class="container mt-5 pt-5">
  <h3 class="mb-4"><i class="bi bi-credit-card-2-front me-2"></i> Checkout</h3>
  <div class="row">
    <div class="col-lg-7">
      <div class="checkout-box">
        <h5>Delivery Information</h5>
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" id="fullName" class="form-control" required>
        </div> 
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" id="email" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">WhatsApp Number</label>
          <input type="text" id="whatsapp" class="form-control" required>
        </div>  
       
        <div class="mb-3">
          <label class="form-label">Delivery Address</label>
          <textarea id="address" class="form-control" rows="3" required></textarea>
        </div>
      
        <div class="alert alert-info">
          ðŸšš Delivery is only within Ibadan.<br>ðŸ’µ Delivery fee is paid on delivery.<br>ðŸ“ž We will contact you immediately after payment.
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="checkout-box">
        <h5>Order Summary</h5>
        <div id="checkout-items"></div>
        <hr>
        <div id="checkout-promo" class="text-success mb-2"></div>
        <h4>Total: â‚¦<span id="checkout-total">0.00</span></h4>
        <button id="pay-btn" class="btn btn-orange w-100 mt-3">
          Pay Now <i class="bi bi-shield-check ms-2"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://js.paystack.co/v1/inline.js"></script>

<script>
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// Update cart badge
function updateCartCount() {
  const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
  document.getElementById("cart-count").textContent = totalItems;
}
updateCartCount();

// Calculate local promo for display
function calculateLocalPromo(cart) {
  let totalQty = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
  let promoText = "";
  let discount = 0;

  if (totalQty >= 30) {
    promoText = "ðŸŽ‰ 20% Festive Promo";
    discount = 0.2;
  } else if (totalQty >= 20) {
    promoText = "ðŸŽ‰ 15% Festive Promo";
    discount = 0.15;
  }

  let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
  let discountedTotal = total - total * discount;

  return { total: discountedTotal, promoText };
}

// Render checkout
function renderCheckout() {
  let container = document.getElementById("checkout-items");
  container.innerHTML = "";

  cart.forEach(item => {
    container.innerHTML += `
      <div class="d-flex justify-content-between mb-2">
        <div>${item.name} (x${item.quantity})</div>
        <div>â‚¦${(item.price * item.quantity).toLocaleString()}</div>
      </div>
    `;
  });

  const { total, promoText } = calculateLocalPromo(cart);
  document.getElementById("checkout-total").textContent = total.toLocaleString();
  document.getElementById("checkout-promo").textContent = promoText;
}

renderCheckout();

// Pay button
document.getElementById("pay-btn").addEventListener("click", async () => {
  const name = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("whatsapp").value.trim();
  const address = document.getElementById("address").value.trim();
  const email = document.getElementById("email").value.trim();

  if (!name || !phone || !address || !email) return alert("Fill all delivery details.");

  try {
    const res = await fetch("https://victoriouschips.onrender.com/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cart, customer: { name, phone, address, email } })
    });

    const data = await res.json();
    if (data.error) return alert(data.error);

    // Update checkout display from backend response
    if (data.promo) document.getElementById("checkout-promo").innerText = `ðŸŽ‰ ${data.promo}`;
    document.getElementById("checkout-total").innerText = (data.amount / 100).toLocaleString();

    PaystackPop.setup({
      key: data.public_key,
      email: data.email,
      amount: data.amount,
      ref: data.reference,
callback: function (response) {
  const phone = document.getElementById("whatsapp").value.trim();

  localStorage.removeItem("cart");

  // Redirect to backend page
window.location.href =
  "https://victoriouschips.onrender.com/payment-success/" +
  response.reference + "/" + phone;
}
    }).openIframe();

  } catch (err) {
    console.error(err);
    alert("Payment service unavailable. Try again.");
  }
});
</script>

</body>
</html>
